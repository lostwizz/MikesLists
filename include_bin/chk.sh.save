#!/bin/bash
# ==========================================
# Django Health Check - Magenta Edition v3.1
# ==========================================

ENVS=("dev" "test" "live")
SERVICES=("gunicorn-MikesLists-dev" "gunicorn-MikesLists-test" "gunicorn-MikesLists-live" "nginx")

declare -A URLS
URLS["dev"]="http://localhost:8001/health/"
URLS["test"]="http://localhost:8002/health/"
URLS["live"]="http://localhost:80/health/"

# Colors
GREEN="\e[32m"
RED="\e[31m"
YELLOW="\e[33m"
MAGENTA="\e[35m"
RESET="\e[0m"

OK_COUNT=0
FAIL_COUNT=0
WARN_COUNT=0

echo -e "${MAGENTA}=========================================="
echo -e "        Django Environment Health Check"
echo -e "==========================================${RESET}"

# [1] Service Status
echo -e "\n${MAGENTA}[1] Service Status:${RESET}"
for SVC in "${SERVICES[@]}"; do
    if systemctl is-active --quiet "$SVC"; then
        echo -e "  ${GREEN}✔ $SVC is RUNNING${RESET}"
        ((OK_COUNT++))
    else
        echo -e "  ${RED}✖ $SVC is NOT RUNNING${RESET}"
        ((FAIL_COUNT++))
    fi
done

# [2] Environment Integrity & DEBUG Check
echo -e "\n${MAGENTA}[2] Environment & Settings Verification:${RESET}"
for ENV in "${ENVS[@]}"; do
    echo -e "  --- ${ENV} ---"
    VENV_PY="/srv/django/venv-${ENV}/bin/python"
    MANAGE_PY="/srv/django/MikesLists_${ENV}/manage.py"

    # 1. Verify Python Interpreter
    ACTUAL_PY=$($VENV_PY -c "import sys; print(sys.executable)" 2>/dev/null)
    if [[ "$ACTUAL_PY" == *"/venv-${ENV}/"* ]]; then
        echo -e "    Python:   ${GREEN}✔ Correct${RESET}"
    else
        echo -e "    Python:   ${RED}✖ MISMATCH${RESET} ($ACTUAL_PY)"
    fi

    # 2. Verify Settings Module (Tail handles shell noise)
    ACTIVE_SETTING=$($VENV_PY $MANAGE_PY shell -c "from django.conf import settings; print(settings.SETTINGS_MODULE)" 2>/dev/null | tail -n 1)
    
    if [[ "$ACTIVE_SETTING" == *"$ENV"* ]]; then
        echo -e "    Settings: ${GREEN}✔ Correct${RESET} ($ACTIVE_SETTING)"
        ((OK_COUNT++))
    else
        echo -e "    Settings: ${RED}✖ WRONG MODULE${RESET} ($ACTIVE_SETTING)"
        ((FAIL_COUNT++))
    fi

    # 3. Explicit DEBUG Check
    DEBUG_STATUS=$($VENV_PY $MANAGE_PY shell -c "from django.conf import settings; print(settings.DEBUG)" 2>/dev/null | tail -n 1)
    
    if [[ "$DEBUG_STATUS" == "True" ]]; then
        if [[ "$ENV" == "live" ]]; then
            echo -e "    DEBUG:    ${RED}✖ TRUE (Security Risk!)${RESET}"
            ((FAIL_COUNT++))
        else
            echo -e "    DEBUG:    ${YELLOW}⚠ True (Standard for Dev)${RESET}"
            ((WARN_COUNT++))
        fi
    else
        echo -e "    DEBUG:    ${GREEN}✔ False${RESET}"
        ((OK_COUNT++))
    fi
done

# [3] Socket Verification
echo -e "\n${MAGENTA}[3] Socket Verification:${RESET}"
for ENV in "${ENVS[@]}"; do
    SOCK="/srv/django/MikesLists_${ENV}/MikesLists.sock"
    if [ -S "$SOCK" ]; then
        echo -e "  ${GREEN}✔ $ENV Socket Found${RESET}"
        ((OK_COUNT++))
    else
        echo -e "  ${RED}✖ $ENV Socket MISSING${RESET} ($SOCK)"
        ((FAIL_COUNT++))
    fi
done

# [4] HTTP Endpoint Checks
echo -e "\n${MAGENTA}[4] HTTP Endpoint Checks:${RESET}"
for ENV in "${ENVS[@]}"; do
    URL="${URLS[$ENV]}"
    RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" "$URL")
    if [ "$RESPONSE" == "200" ]; then
        echo -e "  ${GREEN}✔ $ENV (200 OK)${RESET}"
        ((OK_COUNT++))
    else
        echo -e "  ${RED}✖ $ENV (HTTP $RESPONSE)${RESET}"
        ((FAIL_COUNT++))
    fi
done

# [5] Django Deployment Check
echo -e "\n${MAGENTA}[5] Django Security Check (--deploy):${RESET}"
for ENV in "${ENVS[@]}"; do
    echo -ne "  --- ${ENV} --- "
    # We look specifically for the HSTS/Security warnings
    CHECK_OUT=$(/srv/django/venv-${ENV}/bin/python /srv/django/MikesLists_${ENV}/manage.py check --deploy 2>&1)
    
    if [[ "$CHECK_OUT" == *"System check identified no issues"* ]]; then
        echo -e "${GREEN}✔ Clean${RESET}"
        ((OK_COUNT++))
    else
        # Count critical errors as FAIL, warnings as WARN
        if [[ "$CHECK_OUT" == *"ERRORS:"* ]]; then
            echo -e "${RED}✖ ERRORS FOUND${RESET}"
            ((FAIL_COUNT++))
        else
            echo -e "${YELLOW}⚠ Warnings Exist${RESET}"
            ((WARN_COUNT++))
        fi
    fi
done



# Final Summary
echo -e "\n${MAGENTA}=========================================="
echo -e "                SUMMARY"
echo -e "==========================================${RESET}"
echo -e "${GREEN}✔ OK: $OK_COUNT${RESET}  ${YELLOW}⚠ WARN: $WARN_COUNT${RESET}  ${RED}✖ FAIL: $FAIL_COUNT${RESET}"

if (( FAIL_COUNT > 0 )); then
    echo -e "OVERALL STATUS: ${RED}FAIL${RESET}"
elif (( WARN_COUNT > 0 )); then
    echo -e "OVERALL STATUS: ${YELLOW}WARN${RESET}"
else
    echo -e "OVERALL STATUS: ${GREEN}PASS${RESET}"
fi
echo -e "${MAGENTA}==========================================${RESET}"
